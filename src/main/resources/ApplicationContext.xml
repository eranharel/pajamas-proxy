<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">

  <bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
    <property name="ignoreUnresolvablePlaceholders" value="false"/>
    <property name="systemPropertiesModeName" value="SYSTEM_PROPERTIES_MODE_OVERRIDE"/>
    <property name="location" value="file:#{ systemProperties['pajamas.properties'] }"/>
    <!-- default properties -->
    <property name="properties">
      <map>
        <entry key="pajamas.localPort" value="11511"/>
        
        <!-- jmemcached deamon config properties -->
        <entry key="pajamas.deamon.verbose" value="false"/>
        <entry key="pajamas.deamon.binary" value="true"/>
        
        <!-- spymemcached client config properties -->
		    <entry key="pajamas.client.operationTimeout" value="5000"/>
		    <entry key="pajamas.client.timeoutExceptionThreshold" value="1998"/>
        <entry key="pajamas.client.protocol" value="BINARY"/>
        <entry key="pajamas.client.hashAlg" value="KETAMA_HASH"/>
        <entry key="pajamas.client.locatorType" value="CONSISTENT"/>
        <entry key="pajamas.client.usenagle" value="true"/>
        <entry key="pajamas.client.failureMode" value="Redistribute"/>
        
        <!-- JMX config properties -->
        <entry key="pajamas.jmx.http.port" value="8081"/>
        <entry key="pajamas.jmx.http.host" value="0.0.0.0"/>
      </map>
    </property>
  </bean>

  <bean id="daemon" class="com.thimbleware.jmemcached.MemCacheDaemon">
    <constructor-arg ref="cacheProxy"/>
    <property name="binary" value="${pajamas.deamon.binary}"/>
    <property name="verbose" value="${pajamas.deamon.verbose}"/>
    <property name="addr">
      <bean class="java.net.InetSocketAddress">
        <constructor-arg value="${pajamas.localPort}"/>
      </bean>
    </property>
  </bean>
  
  <bean id="cacheProxy" class="com.outbrain.pajamasproxy.memcached.proxy.SpyCacheProxy">
    <constructor-arg ref="memcachedClient"/>
  </bean>

  <bean id="memcachedClient" class="net.spy.memcached.utils.MemcachedClientFactoryBean">
    <property name="servers" value="${pajamas.remoteHosts}"/>
    <property name="protocol" value="${pajamas.client.protocol}"/>
    <property name="transcoder">
      <bean class="com.outbrain.pajamasproxy.memcached.adapter.SpyCacheElementTranscoder"/>
    </property>
    <property name="opTimeout" value="${pajamas.client.operationTimeout}"/>
    <property name="timeoutExceptionThreshold" value="${pajamas.client.timeoutExceptionThreshold}"/>
    <property name="hashAlg" value="${pajamas.client.hashAlg}"/>
    <property name="locatorType" value="${pajamas.client.locatorType}"/>
    <property name="failureMode" value="${pajamas.client.failureMode}"/>
    <property name="useNagleAlgorithm" value="${pajamas.client.usenagle}"/>
  </bean>  
	
	<!-- JMX -->
	<bean id="mbeanServer" class="org.springframework.jmx.support.MBeanServerFactoryBean">
    <property name="locateExistingServerIfPossible" value="true"/>
	</bean>
	
	<bean id="mbeanExporter" class="org.springframework.jmx.export.MBeanExporter">
    <property name="beans">
      <map>
        <entry key="com.outbrain.pajamasproxy.memcached.monitor.Statistics:type=Statistics" value-ref="statisticsMBean"/>
        <entry key="com.outbrain.pajamasproxy.memcached.monitor.CacheCluster:type=Manager" value-ref="cacheClusterMBean"/>
        <entry key="Server:name=httpAdaptor" value-ref="httpAdaptor"/>
        <entry key="Server:name=xsltProcessor" value-ref="xsltProcessor"/>
      </map>
    </property>
    <property name="server" ref="mbeanServer"/>    
	</bean>
	
	<bean id="statisticsMBean" class="com.outbrain.pajamasproxy.memcached.monitor.Statistics">
    <constructor-arg ref="cacheProxy"/>
	</bean>
	
	<bean id="cacheClusterMBean" class="com.outbrain.pajamasproxy.memcached.monitor.CacheCluster">
	 <constructor-arg ref="memcachedClient"/>
	</bean>
	
  <bean id="httpAdaptor" class="mx4j.tools.adaptor.http.HttpAdaptor">
    <property name="host" value="${pajamas.jmx.http.host}"/>
    <property name="port" value="${pajamas.jmx.http.port}"/>
    <property name="processor" ref="xsltProcessor"/>
	</bean>
	
	<bean id="xsltProcessor" class="mx4j.tools.adaptor.http.XSLTProcessor"/>
	
	<!-- start httpAdaptor -->
	<bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
    <property name="targetObject" ref="httpAdaptor"/>
    <property name="targetMethod" value="start"/>
	</bean>
</beans>
